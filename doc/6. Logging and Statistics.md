# 6. Logging and Statistics

Beside the normal messages generated by the program the most interesting part of e2guardian is logging of the client accesses, 
e.g. logging who accessed which site, with lots of additional information (status code, size in bytes, virus checked.)

## 6.1 Program messages

E2guardian send its info messages, warning and error messages to the standard linux syslog destination using 'e2guardian' as tag.

If you prefer to send these messages to stdout/stderr (specially when e2guardian is running in forground for debugging purposes)
you may change the configuration options in the main config file e2guardian.conf:

  set_error = 'stderr'
  set_info = 'stdout'
  set_warning = 'stderr'

The default configuration is using:

  set_error = 'syslog:LOG_ERR'
  set_info = 'syslog:LOG_INFO'
  set_warning = 'syslog:LOG_WARNING'

( Read more how to configure the logger in section 8.6 Logger )

### 6.1.1 Docker mode

When running e2guardian in a docker container (see Section 2.x) you may use the configuration option:

    dockermode = on

We will then send all program messages to stderr (as stderr is not buffered by docker)
and the access log to stdout. (so you may use 'docker logs -f' or other docker management tools
to see the output of e2guardian)

## 6.2 Access Logger

When a client request to visit a website the server will respond and send the requested data.
E2guardian will collect some infomation on this request/responses and generate a log entry.

These AccessLog entries will by default go to '/var/log/e2guardian/access.log', 
there is a configuration option in e2guardian.conf:

  set_accesslog = 'file:/var/log/e2guardian/access.log'

You may send it to another destination or to syslog (or in case of docker mode turned on to stdout)

We have some predefined log formats with specific columns and delimiters, e.g.:

    1 = Dansguardian format (space delimited)
    2 = CSV-style format
    3 = Squid Log File Format
    4 = Tab delimited
    5 = Protex format

but you may define your own logging format whith your choice of columns and delimiters (NEW in v.5.5)

To decrease the amount of logged data you may filter WHAT should be logged:

    loglevel = 3
    # 0 = none  1 = just denied  2 = all text based  3 = all requests

    logexceptionhits = 2
    # Log if an exception (user, ip, URL, phrase) is matched and so
    # the page gets let through.  Can be useful for diagnosing  why a site gets through the filter.

    logadblocks = off
    # Enable logging of "ADs" category blocks

### 6.2.1 Custom log formats

You may choose to define your own log format by setting the following configuration option in e2guardian.conf:

    logformat = "time clientname hostname url statuscode bytes"
    logdelimiter = "\t"

You may choose from the following columns:

    - time : time of the request in humanreadably format
    - timestamp: time as UNIX timestamp
    - timeutc: time in UTC format
    - clientname: DNS Name of the client
    - clientip: IP Adress of client
    - hostname:
    - hostip:
    - method: HTTP method used: GET or POST or CONNECT
    - proto: the protocol used: HTTP or HTTPS
    - url:
    - path:
    - port:
    - params:
    - statuscode: HTTP status code e.g. 200
    - status: HTTP status e.g. OK
    - bytes: response size in bytes
    - ...

## 6.3 Request logs

This is a new feature (in v5.3.4 onwards) which can help in trouble shooting

It would not normally be turned on on production systems, except when
diagnosing any sudden-death symptoms.

Enable by defining rqloglocation in e2guardian.conf

This log will be in the same format as access.log.  It shows all requests
before any processing is performed.

The filtergroup should be ignored as it will normally show the default group 
as the record is written to the log before any authentication plug-ins are actioned.

The following information is provided in the 'what' field:-

thread_id - allows thread to be followed and also cross-matched to syslog and access.log

TRANS, PROXY, THTTPS, MITM, REQMOD or RESPMOD showing the source of the 
request

- TRANS - transparent http

- PROXY - requests via the normal proxy port(s) (8080 etc) - includes transparent http

- THTTPS - requests via tranparent https port + flags for presence of TLS and SNI

- MITM - requests from within a MITM session (can be via PROXY or THTTPS)

- REQMOD - requests to ICAP REQMOD service

- RESPMOD - requests to ICAP RESPMOD service

WARNING - this option also modifies the access.log!

With this option active the thread_id is also added to the front of the 'what'
field in the access.log to allow cross-checking between the logs.

## 6.4 Programm statistics

E2guardian collects some statistics abouts its usage, e.g. the number of connections per seconds.
The default values for dstat are:

    dstatlocation = '/var/log/e2guardian/dstats.log'
    dstatinterval = 300  # = 5 minutes

The following data is collected:

1. Time  - in unix format

2. httpw - Number of httpworker threads running

3. busy - Number of httpworker threads busy handling connections at current time

4. httpwQ - Number of connections waiting in queue for a worker thread.
   In normal use this will be 0 (and on occasion 1 or 2) but will increase once
   all worker threads are busy.   Lowish numbers are OK for transitory peaks.  
   High numbers indicate an overloaded system.   If there is still memory and
   cpu available, then httpworkers may be increased.

5. logQ - Number of messages waiting to be logged to disk.   In normal use 0.  
   An increase in number may indicate system overloading, but should not
   otherwise affect performance.

6. conx - number of connections handled since last stats line.

7. conx/s - average connections per sec over period since last stats line.

8. reqs - indication of number of requests handled since last stats line.  
   Only an indication as requests made over https tunnels (i.e. non-MITM) cannot
   be counted, so each https tunnel is counted as one request.

9. reqs/s - average requests per sec over period since last stats line.

10. maxfd - Indication of the maximum number file descriptor used.

11. LCcnt - Number of List Option Containers in use. A new List Option Container
   is created at start up and on gentle restart.  Old containers are deleted
   once all connections still using it have finished.  Normally figure will be 
   one, but may rise after a gentle restart(s) and should return to one after a 
   period of time.  